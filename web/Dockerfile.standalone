# VibeTunnel Standalone Server Docker Image
# Mount your code and get instant web terminal access with tunnels

FROM node:24-trixie-slim

# Install system dependencies and common development tools
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    make \
    g++ \
    git \
    curl \
    wget \
    vim \
    nano \
    htop \
    tree \
    jq \
    unzip \
    ca-certificates \
    openssh-client \
    dash \
    bash \
    xz-utils \
    libpam0g-dev \
    && ln -sf /bin/dash /bin/sh \
    && rm -rf /var/lib/apt/lists/*

# Install Zig (latest stable) for vibetunnel-fwd build
SHELL ["/bin/bash", "-c"]
ARG ZIG_VERSION=0.15.2
RUN set -euo pipefail; \
    arch="$(uname -m)"; \
    case "$arch" in \
      aarch64|arm64) zig_arch="aarch64-linux";; \
      x86_64|amd64) zig_arch="x86_64-linux";; \
      *) echo "unsupported arch: $arch" >&2; exit 1;; \
    esac; \
    zig_url="https://ziglang.org/download/${ZIG_VERSION}/zig-${zig_arch}-${ZIG_VERSION}.tar.xz"; \
    mkdir -p /usr/local/zig /usr/local/bin; \
    curl -sL "$zig_url" -o /tmp/zig.tar.xz; \
    tar -xf /tmp/zig.tar.xz -C /usr/local/zig --strip-components=1; \
    ln -sf /usr/local/zig/zig /usr/local/bin/zig; \
    zig version

# Install ngrok
RUN curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null \
    && echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | tee /etc/apt/sources.list.d/ngrok.list \
    && apt-get update \
    && apt-get install -y ngrok \
    || echo "Ngrok installation failed, continuing without it"

# Install cloudflared
RUN curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o /usr/local/bin/cloudflared \
    && chmod +x /usr/local/bin/cloudflared \
    || echo "Cloudflared installation failed, continuing without it"

# Install common dev tools
RUN npm install -g pnpm typescript ts-node nodemon

# Set working directory for VibeTunnel
WORKDIR /app

# Copy package files
COPY package*.json ./
COPY pnpm-lock.yaml ./
COPY node-pty ./node-pty
COPY scripts ./scripts

# Install dependencies
ENV PUPPETEER_SKIP_DOWNLOAD=1
RUN pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Ensure vt-fwd sources exist (for web-only context builds)
ARG VT_FWD_REF
RUN if [ ! -d /app/native/vt-fwd ]; then \
      ref="${VT_FWD_REF:-v$(node -p "require('./package.json').version")}"; \
      git clone --depth 1 --filter=blob:none --sparse --branch "$ref" https://github.com/amantus-ai/vibetunnel.git /tmp/vt-src \
        || git clone --depth 1 --filter=blob:none --sparse https://github.com/amantus-ai/vibetunnel.git /tmp/vt-src; \
      git -C /tmp/vt-src sparse-checkout set native/vt-fwd; \
      mkdir -p /app/native; \
      cp -R /tmp/vt-src/native/vt-fwd /app/native/vt-fwd; \
      rm -rf /tmp/vt-src; \
    fi

# Build the project
ENV VT_SKIP_VERSION_SYNC=1
RUN ln -sf /bin/dash /bin/sh && pnpm run build

# Create workspace directory for mounted code
RUN mkdir -p /workspace
WORKDIR /workspace

# Expose default port
EXPOSE 4020

# Set environment variables
ENV NODE_ENV=production
ENV PORT=4020
ENV PATH="/workspace/node_modules/.bin:${PATH}"

# Create entrypoint script that handles command passthrough
RUN cat <<'EOF' > /entrypoint.sh
#!/bin/bash
set -e
# If no arguments provided, show usage
if [ $# -eq 0 ]; then
  echo "VibeTunnel Docker Container"
  echo "Usage: docker run -v /path/to/code:/workspace -p 4020:4020 vibetunnel [OPTIONS]"
  echo ""
  echo "Examples:"
  echo "  docker run -v \$(pwd):/workspace -p 4020:4020 vibetunnel --ngrok"
  echo "  docker run -v \$(pwd):/workspace -p 4020:4020 vibetunnel --cloudflare"
  echo "  docker run -v \$(pwd):/workspace -p 4020:4020 vibetunnel --no-auth --ngrok"
  echo ""
  echo "Your code will be available at /workspace in the terminal"
  echo "Access via browser at http://localhost:4020 or the tunnel URL"
  exit 1
fi
# Start VibeTunnel with all provided arguments
exec node /app/dist/cli.js --bind 0.0.0.0 "$@"
EOF
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]

# Default arguments (can be overridden)
CMD ["--no-auth"]

# Example Usage:
#
# Build the image:
# docker build -f Dockerfile.standalone -t vibetunnel .
#
# Mount your code and run with ngrok:
# docker run -v $(pwd):/workspace -p 4020:4020 vibetunnel --ngrok
#
# With Cloudflare tunnel:
# docker run -v /path/to/project:/workspace -p 4020:4020 vibetunnel --cloudflare
#
# With ngrok auth token:
# docker run -v $(pwd):/workspace -p 4020:4020 vibetunnel --ngrok --ngrok-auth YOUR_TOKEN
#
# Local development (no tunnel):
# docker run -v $(pwd):/workspace -p 4020:4020 vibetunnel --no-auth
#
# With authentication:
# docker run -v $(pwd):/workspace -p 4020:4020 vibetunnel --enable-ssh-keys
#
# Your mounted code will be available at /workspace in the terminal
# Access via http://localhost:4020 or the tunnel URL
